# name: Litera.id Production Deployment

# on:
#   push:
#     branches: [main]
#   workflow_dispatch:

# jobs:
#   build_and_push_image:
#     name: üê≥ Build & Push Docker Image
#     runs-on: ubuntu-latest

#     steps:
#       - name: üì¶ Checkout Repository
#         uses: actions/checkout@v3

#       - name: üîß Setup Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: üîê Login to DockerHub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: üèóÔ∏è Build and Push Image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./
#           file: ./docker/app/Dockerfile
#           push: true
#           tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_PROJECT_ID }}:prod
#           no-cache: true
#           build-args: |
#             NEXT_PUBLIC_API_URL=${{ secrets.PRODUCTION_API_URL }}
#             NEXT_PUBLIC_ANALYTICS_ID=${{ secrets.PRODUCTION_ANALYTICS_ID }}
#             NEXT_PUBLIC_ENVIRONMENT=production

#   deploy_to_server:
#     name: üöÄ Deploy to Server
#     runs-on: ubuntu-latest
#     needs: build_and_push_image

#     steps:
#       - name: üìÑ Generate Secrets File
#         uses: 0ndt/envfile@v2
#         with:
#           secrets: ${{ toJSON(secrets) }}
#           exclude: DEPLOYMENT_*, STAGING_*, DEV_*

#       - name: üì§ Upload Secrets Server
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.DEPLOYMENT_HOST }}
#           port: ${{ secrets.DEPLOYMENT_PORT }}
#           username: ${{ secrets.DEPLOYMENT_USER }}
#           key: |
#             ${{ secrets.DEPLOYMENT_SSH_KEY }}
#           source: '.env'
#           target: '/opt/${{ secrets.DOCKER_PROJECT_ID }}/production'

#       - name: üîÑ Deploy and Restart Container
#         uses: appleboy/ssh-action@v1.0.0
#         with:
#           host: ${{ secrets.DEPLOYMENT_HOST }}
#           port: ${{ secrets.DEPLOYMENT_PORT }}
#           username: ${{ secrets.DEPLOYMENT_USER }}
#           key: |
#             ${{ secrets.DEPLOYMENT_SSH_KEY }}
#           script: |
#             cd /opt/${{ secrets.DOCKER_PROJECT_ID }}/production

#             # Sync source code
#             git fetch origin
#             git reset --hard origin/main
#             git clean -fd

#             # Remove prefix on incoming secrets
#             sed -i 's/^PRODUCTION_//g' .env

#             # Re-run container (clean)
#             docker-compose -p "${{ secrets.DOCKER_PROJECT_ID }}-prod" -f docker-compose.yml -f docker-compose.prod.yml pull
#             docker-compose -p "${{ secrets.DOCKER_PROJECT_ID }}-prod" -f docker-compose.yml -f docker-compose.prod.yml down
#             docker-compose -p "${{ secrets.DOCKER_PROJECT_ID }}-prod" -f docker-compose.yml -f docker-compose.prod.yml up -d
#             docker image prune -f
#             docker container prune -f
#   purge_cache:
#     name: üßπ Purge Cloudflare Cache
#     runs-on: ubuntu-latest
#     needs: deploy_to_server
#     steps:
#       - name: Purge Cloudflare Cache
#         run: |
#           curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
#           -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
#           -H "Content-Type: application/json" \
#           --data '{"purge_everything":true}'
